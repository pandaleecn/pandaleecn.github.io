---
layout: post
title: 'QQ音乐面试前面经'
date: 2018-08-25
author: 李大鹏
cover: ''
tags: iOS
---

#### 面经 1：

- 一面，腾讯 QQ 音乐项目组-iOS-2020-08-11 20:30
- 二面，腾讯 QQ 音乐项目组-iOS-2020-08-17 19:00

##### 1、自我介绍；

- 简介  
  我叫李大鹏，14 年底正式参加 iOS 工作，至今有 6 年了，平时喜欢分析源码，阅读中英文技术书籍和文档，经常关注大厂技术团队博客，积累了持续学习的习惯。

- 擅长

  - iOS 生态中的各种 SDK 应用和 Debug，先后开发了两款包含 UGC 的应用，擅长 feed 流的优化，涉及到音视频的播放和采集，编码部分较少，比如商品视频的多角度拍摄、UGC 中的类似微信朋友圈的视频交互。
  - 对各种架构模式的能够灵活运用。比如在现在项目中订单流程管理中，使用了 vuex 常用的 view-state 状态管理器模式，解决订单生成流程中的耦合问题。
  - 对全栈的兴趣和快速的学习和实践能力，大学时独立用 Java 写过 Web 项目。在面试邀约前我正在用业余时间写一个音乐播放器的项目，后台用的 Go 和 vue，我在边学边用的基础上，一周业余时间就完成了一套包含 rbac 的基础后台管理系统。

- 经验

  - 我先后在 3 家公司从事 iOS 开发工作，现在公司是时间最久的，从 15 年到现在。公司的项目是由我从零到一搭建的，iOS 团队也逐渐的扩大到 5 人，在架构方面积累了挺多经验，也给了我很多实践的空间提升自己。

- 写一个音乐播放器项目的原因有两个：
  - 实验新的架构方式和完善音频开发技术栈，大学时毕业论文就是音乐播放器，一直想探索音频深层技术栈；
  - 我日常使用场景只有运动、学习、工作，现在的音乐软件干扰太多，计划实现打开就选择场景的效果。
  - 包含管理后台和移动端，后端已经用 Go 和 vue 写好了，面试通知后就暂时搁置复习了。

##### 2、现在在做项目的难点是什么，一些细节延伸；

- 关于架构和设计模式，现在主要的架构模式主要有 5 中，MVC、MVVM-C、MVP、MVC-VS、Clean，Tea 和 MAVB。
  - 订单业务流。我们的项目设计的 Usecase 比较复杂，而且延伸比较长，选择钻石、款式、定制信息、客户信息等等，最初采用 MVC 的方式开发，导致业务非常紊乱，尤其是在版本迭代的时候，效率很低。我引入了 MVC+VS 的设计模式，将所有控制器中的 View State 独立出来并且下沉，合并父类，多个控制器共同存取。在此基础上引入 Coordinate（协调器），对定制流程的路由进行控制。
  - 珠宝定制键盘，支持多种字体、文字输入，与页面依赖较低，考虑到后期 iPhone 版的开发，使用 CTMediator 进行组件化开发。将该模块打包成 Pods，通过添加分类和运行时，实现组件之间的引用和关联。后期计划大规模使用组件化，将 UGC 、定制、管理等模块拆分，壳化后细分手机端，在考虑引入 Tea（Elm）架构和去 model 模式，reducer 出 json 进行组件的衔接。

##### 两个问题

- 我通过的希望大吗？因为感觉发挥的不太好。后面还有技术面吗？
- 因为我在准备 Flutter 技术的集成，如果没有技术面我就全力加班准备把手头上的事情做完，然后文档化，方面后续的交接。

##### 自我规划

- 如果能拿到 offer，首先补充音视频知识，尽快吸收部门的代码规范和文档，按照部门发展方向掌握新技术。
- 在巩固基础的同时，逐渐深入学习 mach 和 BSD 层。
- 短期：保持空杯心态，熟悉团队文化，尽快融入新团队。
- 长期：提高架构能力，保持全栈知识吸收，在公司需要更资深人员时，争取自己能够胜任。

---

---

---

---

##### 3、直播室聊天模块怎么设计，难点在哪里；

##### 4、怎么从 100 万条数据中选出排在前面的 100 条数据（topK 问题）；

- Hash 去重
- 小顶堆或分治
  - 小顶堆。取 100 条元素，构建小顶堆，顺序往后对比，遇到更大的数则替换堆顶，重新构建小顶堆。O((N-M)logM)，空间复杂度是 M，I/O 比较高；
  - 分治法。分 100 份 1 万的组，取前 100，排序后合并重拍。
- 重拍后，进行合并操作，返回结果。

##### 5、网络-dns，长连接，httpDNS；

- DNS 是网络域名解析服务，当我们对一个域名进行请求时，负责域名解析成 IP 地址。客户端发出请求后，DNS 首先请求本地 DNS 服务器，一般 80%几率能够命中并返回。如果本地 DNS 服务器没有缓存，则往根服务器请求，并逐级请求，命中后返回。使用解析后的 IP 地址进行后续请求。
- HttpDNS，防止 DNS 劫持，因为在域名请求过程中，由于运营商的问题或者黑客篡改 DNS 等风险的存在，导致解析到钓鱼的 DNS 上，存在安全隐患。我们在开发时，一般使用 IP 直连的方式，进行规避。使用 HttpDNS 时需要将域名放入 head 字段，post 时也需要将数据放入，在集成就项目时，可替换 URLProtocol，AFN 需要使用 Runtime 替换。
- 长连接，有状态
  - HTTP 每次请求完成，就会把 TCP 断开，是短链接。用 socket 编程使用 TCP，可以通过代码区控制关闭时间，连接和状态在客户端和服务的进行中一直存在。
  - 三次握手，采用 SYN 握手信号、ACK 消息响应、seq 序列号来进行三次确认连接
  - 四次挥手，握手的 SYN 信号换成了 FIN 信号，最后服务器收到客户机的关闭确认后立即关闭，客户机在时间等待状态结束后关闭，防止收到的 ACK 是上次的确认信号。
  - 套接字是 TCP 协议的封装，调用接口（API）。
  - 实现：通过 Socket 实现，基于 CocoaAsyncSocket 框架，借鉴了 NSURLSession 的设计模式，对 Request、Response 进行封装、序列化，对 Socket 实现了线程常驻、任务式调用和粘包处理等功能。

##### 6、快排实现过程及复杂度，二叉树的遍历前序、后续遍历；

##### 8、聊下性能优化；

- 安装包瘦身
  - 使用 Linked-Map 工具，查看.o 目标文件大小，针对性合并静态库、减少工程类和方法。
  - 如果 Swift 用的少，就删除，纯 OC 编程
  - Assets Catalogs 可以提高 I/O 性能，和一些方便功能，安装包会选择合适的图片倍率下载，但是会增加包体积和缓存占用，视情况选择。
  - 删除无用多媒体文件，包括图片，优先网络请求，使用占位图，尽量用 jpg，不能用的使用 tinypng 有损压缩，定期更新资源包，LSUnusedResources 排查图片， 利用 tint color 精简单色图标。
  - 使用 strip -x 命令处理动态库。
  - Build Settings 中的 Link-Time Optimization=Incremental。
- 性能优化
  - 性能检测
    - 全局，采用 AOP 的方式，在生命周期函数中使用 swizzle 添加统计代码。
    - 局部，使用埋点的方式，针对业务流进行用户路径和漏斗埋点。
    - 代码实时检测内存、CPU、刷新帧率。
    - 使用真机进行测试。
  - 代码优化
    - 选择合适的集合类型，字典和 Set 操作元素都是 O(1)，数组针对对象复杂度是 O(n)，针对索引 O(1)，二分查找 O（log n）。
    - 使用 GCD 将耗时操作放到非主线程上，要控制线程数，防止线程爆炸和死锁。
    - I/O 对性能消耗很大，减少 I/O 次数，合理使用 NSCache，之前 SDWebImage 在 iPad 中未释放内存导致闪退，我还提了 bugfix。
    - 控制 App 的 Wake 次数，如：通知、VoIP、定位、蓝牙都会从 Standby 状态唤起，消耗很大。
  - 启动优化
    - 利用 DYLD_PRINT_STATISTICS 分析 main()函数之前的耗时。
    - Page Fault 重排，减少签名认证时间。
    - 在编译时注册启动优先级，根据不同的优先级，选择在 FinishLaunch/首页/加载完成三种情况下执行。
    - 首页采用预排版，从后台唤醒的冷启动，可以不加载根控制器
  - 网络优化
    - 服务器在香港，网络经常不稳定，有的时候 DNS 无法解析。自建钻石云数据库，金价变动较快，对实时性要求高。
    - 两种重连方式：IP 直连和网关代理服务；
    - 两种重试方式：非关键义务，使用 Http 重试，消除 SSL 风险；原请求重试。
  - Instrument 优化

##### 9、如何保障 App 的数据安全；

- 安装包，防止逆向、反编译
  - 代码混淆，关键字符串混淆、关键文件伪装，如伪装成图片
  - main 函数前关闭 ptrace，防止黑客使用 gdb 或 lldb 调试
  - 越狱检测，高安全应用禁止越狱使用，越狱可使用 Cycript 类语言直接执行库函数
  - 自检，生成 md5，与服务器对比
  - 敏感业务使用 C 或汇编，防止 OC 被注入
- 编码过程，保护敏感信息
  - 对敏感信息加密，存储到 keychain
  - 对敏感信息，使用后清空
  - 敏感信息防止键盘缓存，关闭自动纠错
  - 设置信息获取状态，如：必须解锁后才能获取敏感信息
  - 进入后台时替换截图，防止窥屏
- 网络通信，加密传输
  - 使用 Https
  - 客户端使用 RSA，服务端使用 AES 或 DES
  - 敏感信息分类加密，依次使用 AES、3DES、DES、散列函数等
  - 使用 HttpDNS 防止中间人攻击
  - 关键信息使用二进制协议或自建协议

##### 10、runLoop，和 runloop 的运用，实现细节；

- RunLoop 是通过内部维护的时间来对时间/消息进行管理的一个对象。
- 正常运行在用户态，没有消息管理时会切换到内核态，有消息处理时切换到用户态，用户线程被唤醒。
- main 函数在启动时调用 UIApplication.main 启动主线程的 RunLoop。

##### 11、现在做过的项目哪个最难，对自己的成长帮助最大；

##### 12、多线程与线程同步锁。

##### 你的 app 架构是什么，有什么优缺点、为什么这么做、怎么改进

##### Feed 流优化

- 预排版，在 ViewModel 中封装 CellLayout，缓存 CoreText 排版结果、各控件高度、Cell 高度，预加载时异步计算。
- 预渲染，需要圆角的图片，使用曲线异步绘制后设置，避免离屏渲染，使用后异步写缓存。
- 异步绘制

  - 参考 ASDK 的原理，实现了异步绘制控件，针对客户常用页面做优化，比如我们项目中的选择钻石页面。
  - 当 TableView 快速滑动时，取消超出显示区域的绘制内容。UIView 在请求异步绘制时，Layer 传递 BOOL(^isCancelled)() 的 block，控件绘制时判断是否已取消。
  - 还试过一种方式，停止滑动时预先绘制那个位置附近的 Cell，忽略当前滑动中的 Cell，会出现大量空白内容，体验不好。

- 全局并发控制，大量异步绘制时，由于 CGFont 存在锁，导致线程休眠或阻塞，造成线程堆积，CPU 在线程切换时开销较大，出现少量。通过使用多串行队列控制并发数的方式解决，将图像解码、对象释放、异步绘制等，都按优先级不同放入了全局的 serial queue 中执行。
- 使用 UIView.layer.contents 手动实现关键业务的简单图片加载。
- 列表中有不少视觉元素并不需要触摸事件，这些元素可以用 ASDK 的图层合成技术预先绘制为一张图。
- 尽量减少 Cell 内图层的数量，用 CALayer 替换 UIView。把 Cell 按类型划分，减少 Cell 内不必要的视图对象和操作。
