---
layout: post
title: 'QQ音乐面试前面经'
date: 2018-08-25
author: 李大鹏
cover: ''
tags: iOS
---

#### 面经 1：腾讯 QQ 音乐项目组-iOS-2020-06-19 11:47

##### 1、自我介绍；

##### 2、现在在做项目的难点是什么，一些细节延伸；

- 关于架构和设计模式，现在主要的架构模式主要有 5 中，MVC、MVVM-C、MVP、MVC-VS、Clean，Tea 和 MAVB。
  - 订单业务流。我们的项目设计的 Usecase 比较复杂，而且延伸比较长，选择钻石、款式、定制信息、客户信息等等，最初采用 MVC 的方式开发，导致业务非常紊乱，尤其是在版本迭代的时候，效率很低。我引入了 MVC+VS 的设计模式，将所有控制器中的 View State 独立出来并且下沉，合并父类，多个控制器共同存取。在此基础上引入 Coordinate（协调器），对定制流程的路由进行控制。
  - 珠宝定制键盘，支持多种字体、文字输入，与页面依赖较低，考虑到后期 iPhone 版的开发，使用 CTMediator 进行组件化开发。将该模块打包成 Pods，通过添加分类和运行时，实现组件之间的引用和关联。后期计划大规模使用组件化，将 UGC 、定制、管理等模块拆分，壳化后细分手机端，在考虑引入 Tea（Elm）架构和去 model 模式，reducer 出 json 进行组件的衔接。
-

##### 3、直播室聊天模块怎么设计，难点在哪里；

##### 4、怎么从 100 万条数据中选出排在前面的 100 条数据（topK 问题）；

- Hash 去重
- 小顶堆或分治
  - 小顶堆。取 100 条元素，构建小顶堆，顺序往后对比，遇到更大的数则替换堆顶，重新构建小顶堆。O((N-M)logM)，空间复杂度是 M，I/O 比较高；
  - 分治法。分 100 份 1 万的组，取前 100，排序后合并重拍。
- 重拍后，进行合并操作，返回结果。

##### 5、网络-dns，长连接，httpDNS；

- DNS 是网络域名解析服务，当我们对一个域名进行请求时，负责域名解析成 IP 地址。客户端发出请求后，DNS 首先请求本地 DNS 服务器，一般 80%几率能够命中并返回。如果本地 DNS 服务器没有缓存，则往根服务器请求，并逐级请求，命中后返回。使用解析后的 IP 地址进行后续请求。
- HttpDNS，防止 DNS 劫持，因为在域名请求过程中，由于运营商的问题或者黑客篡改 DNS 等风险的存在，导致解析到钓鱼的 DNS 上，存在安全隐患。我们在开发时，一般使用 IP 直连的方式，进行规避。使用 HttpDNS 时需要将域名放入 head 字段，post 时也需要将数据放入，在集成就项目时，可替换 URLProtocol，AFN 需要使用 Runtime 替换。
- 长连接，通过 Socket 实现，基于 CocoaAsyncSocket 框架，借鉴了 NSURLSession 的设计模式，对 Request、Response 进行封装、序列化，对 Socket 实现了线程常驻、任务式调用和粘包处理等功能。

##### 6、快排实现过程及复杂度，二叉树的遍历前序、后续遍历；

##### 8、聊下性能优化；

- 安装包瘦身
  - 使用 Linked-Map 工具，查看.o 目标文件大小，针对性合并静态库、减少工程类和方法。
  - 如果 Swift 用的少，就删除，纯 OC 编程
  - Assets Catalogs 可以提高 I/O 性能，和一些方便功能，安装包会选择合适的图片倍率下载，但是会增加包体积和缓存占用，视情况选择。
  - 删除无用多媒体文件，包括图片，优先网络请求，使用占位图，尽量用 jpg，不能用的使用 tinypng 有损压缩，定期更新资源包，LSUnusedResources 排查图片， 利用 tint color 精简单色图标。
  - 使用 strip -x 命令处理动态库。
  - Build Settings 中的 Link-Time Optimization=Incremental。
- 性能优化
  - 性能检测
    - 全局，采用 AOP 的方式，在生命周期函数中使用 swizzle 添加统计代码。
    - 局部，使用卖点的方式，针对业务流进行漏斗买点。
    - 代码实时检测内存、CPU、刷新帧率。
    - 使用真机进行测试。
  - 代码优化
    - https://github.com/ming1016/study/wiki/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-iOS-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96
  - 启动优化
    - 利用 DYLD_PRINT_STATISTICS 分析 main()函数之前的耗时。
    - Page Fault 重排，减少签名认证时间。
    - 在编译时注册启动优先级，根据不同的优先级，选择在 FinishLaunch/首页/加载完成三种情况下执行。
    - 首页采用预排版，从后台唤醒的冷启动，可以不加载根控制器
  - 网络优化
    - 服务器在香港，网络经常不稳定，有的时候 DNS 无法解析。自建钻石云数据库，金价变动较快，对实时性要求高。
    - 两种重连方式：IP 直连和网关代理服务；
    - 两种重试方式：非关键义务，使用 Http 重试，消除 SSL 风险；原请求重试。
  - Instrument 优化

##### 9、如何保障 App 的数据安全；

- 安装包，防止逆向、反编译
  - 代码混淆，关键字符串混淆、关键文件伪装，如伪装成图片
  - main 函数前关闭 ptrace，防止黑客使用 gdb 或 lldb 调试
  - 越狱检测，高安全应用禁止越狱使用，越狱可使用 Cycript 类语言直接执行库函数
  - 自检，生成 md5，与服务器对比
  - 敏感业务使用 C 或汇编，防止 OC 被注入
- 编码过程，保护敏感信息
  - 对敏感信息加密，存储到 keychain
  - 对敏感信息，使用后清空
  - 敏感信息防止键盘缓存，关闭自动纠错
  - 设置信息获取状态，如：必须解锁后才能获取敏感信息
  - 进入后台时替换截图，防止窥屏
- 网络通信，加密传输
  - 使用 Https
  - 客户端使用 RSA，服务端使用 AES 或 DES
  - 敏感信息分类加密，依次使用 AES、3DES、DES、散列函数等
  - 使用 HttpDNS 防止中间人攻击
  - 关键信息使用二进制协议或自建协议

##### 10、runLoop，和 runloop 的运用，实现细节；

##### 11、现在做过的项目哪个最难，对自己的成长帮助最大；

##### 12、多线程与线程同步锁。

#### 自我补充

##### 你的 app 架构是什么，有什么优缺点、为什么这么做、怎么改进
