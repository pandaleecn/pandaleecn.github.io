I"•(<h4 id="1-blockä»‹ç»å’Œè°ƒç”¨">1. Blockä»‹ç»å’Œè°ƒç”¨</h4>
<p>å®šä¹‰ï¼šBlockæ˜¯å°†å‡½æ•°åŠå…¶æ‰§è¡Œä¸Šä¸‹æ–‡å°è£…èµ·æ¥çš„å¯¹è±¡ 
<img src="http://files.pandaleo.cn/67c852101669450f90bd710124949ff3.png" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    int multiplier = 6;
    int(^Block)(int) = ^int(int num){
        return num * multiplier;
    };
    Block(2);
}
// ä½¿ç”¨ã€clang -rewrite-objc file.mã€‘æŸ¥çœ‹ç¼–è¯‘ä¹‹åçš„æ–‡ä»¶å†…å®¹
// TBlock.cpp

#ifndef BLOCK_IMPL
#define BLOCK_IMPL
struct __block_impl {
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
};

// @implementation TBlock


struct __TBlock__method_block_impl_0 {
  struct __block_impl impl;
  struct __TBlock__method_block_desc_0* Desc;
  int multiplier;
  __TBlock__method_block_impl_0(void *fp, struct __TBlock__method_block_desc_0 *desc, int _multiplier, int flags=0) : multiplier(_multiplier) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
static int __TBlock__method_block_func_0(struct __TBlock__method_block_impl_0 *__cself, int num) {
  int multiplier = __cself-&gt;multiplier; // bound by copy

        return num * multiplier;
    }

static struct __TBlock__method_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __TBlock__method_block_desc_0_DATA = { 0, sizeof(struct __TBlock__method_block_impl_0)};

static void _I_TBlock_method(TBlock * self, SEL _cmd) {

    int multiplier = 6;
    /* Blockä»‹ç»
     int(^Block)(int) = ^int(int num){
         return num * multiplier;
     };
     */
    int(*Block)(int) = ((int (*)(int))&amp;__TBlock__method_block_impl_0((void *)__TBlock__method_block_func_0, &amp;__TBlock__method_block_desc_0_DATA, multiplier));
    /* Blockè°ƒç”¨
     Block(2);
     */
    ((int (*)(__block_impl *, int))((__block_impl *)Block)-&gt;FuncPtr)((__block_impl *)Block, 2);
}

// @end
</code></pre></div></div>

<h4 id="2-æˆªè·å˜é‡">2. æˆªè·å˜é‡</h4>
<p>åœ¨blockä¸­ä½¿ç”¨å®šä¹‰çš„å˜é‡å«æˆªè·å˜é‡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    int multiplier = 6; // åŸºæœ¬æ•°æ®ç±»å‹
    int(^Block)(int) = ^int(int num){
        return num * multiplier;
    };
    multiplier = 4;
    NSLog(@"result is %d", Block(2)); // result is 12
}
// ä½¿ç”¨ã€clang -rewrite-objc -objc-arc file.mã€‘å‘½ä»¤
</code></pre></div></div>
<ul>
  <li>å±€éƒ¨å˜é‡
    <ul>
      <li>åŸºæœ¬æ•°æ®ç±»å‹ï¼Œæˆªè·å…¶å€¼</li>
      <li>å¯¹è±¡ç±»å‹ï¼Œè¿åŒæ‰€æœ‰æƒä¿®é¥°ç¬¦ä¸€èµ·æˆªè·ã€‚</li>
    </ul>
  </li>
  <li>é™æ€å±€éƒ¨å˜é‡ï¼Œä»¥æŒ‡é’ˆå½¢å¼æˆªè·ã€‚</li>
  <li>å…¨å±€å˜é‡ã€é™æ€å…¨å±€å˜é‡ï¼Œä¸æˆªè·ã€‚</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// TBlock.mæ–‡ä»¶
@implementation TBlock

// å…¨å±€å˜é‡
int global_var = 4;
// é™æ€å…¨å±€å˜é‡
static int static_global_var = 5;

- (void)method
{
    static int multiplier = 6; // é™æ€å±€éƒ¨å˜é‡
    int(^Block)(int) = ^int(int num)
    {
        return num * multiplier;
    };
    multiplier = 4;
    NSLog(@"result is %d", Block(2)); // result is 8
}

@end

// TBlock.cppæ–‡ä»¶

int global_var = 4;
static int static_global_var = 5;

struct __TBlock__method_block_impl_0 {
  struct __block_impl impl;
  struct __TBlock__method_block_desc_0* Desc;
    // æˆªè·å±€éƒ¨å˜é‡çš„å€¼
  int var;
    // è¿åŒæ‰€æœ‰æƒä¿®é¥°ç¬¦ä¸€èµ·æˆªè·
  __unsafe_unretained id unsafe_obj;
  __strong id strong_obj;
    // ä»¥æŒ‡é’ˆå½¢å¼æˆªè·å±€éƒ¨å˜é‡
  int *static_var;
    // å¯¹å…¨å±€å˜é‡ã€é™æ€å…¨å±€å˜é‡ä¸æˆªè·

  __TBlock__method_block_impl_0(void *fp, struct __TBlock__method_block_desc_0 *desc, int _var, __unsafe_unretained id _unsafe_obj, __strong id _strong_obj, int *_static_var, int flags=0) : var(_var), unsafe_obj(_unsafe_obj), strong_obj(_strong_obj), static_var(_static_var) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};

// è°ƒç”¨
static void _I_MCBlock_method(MCBlock * self, SEL _cmd) {

    int var = 1;

    __attribute__((objc_ownership(none))) id unsafe_obj = __null;
    __attribute__((objc_ownership(strong))) id strong_obj = __null;


    static int static_var = 3;

    void(*Block)(void) = ((void (*)())&amp;__MCBlock__method_block_impl_0((void *)__MCBlock__method_block_func_0, &amp;__MCBlock__method_block_desc_0_DATA, var, unsafe_obj, strong_obj, &amp;static_var, 570425344));

    ((void (*)(__block_impl *))((__block_impl *)Block)-&gt;FuncPtr)((__block_impl *)Block);
}
</code></pre></div></div>

<h4 id="3-__blockä¿®é¥°ç¬¦">3. __blockä¿®é¥°ç¬¦</h4>
<ul>
  <li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹è¢«æˆªè·å˜é‡è¿›è¡Œèµ‹å€¼æ“ä½œéœ€æ·»åŠ __blockä¿®é¥°ç¬¦  <br />
<img src="http://files.pandaleo.cn/089f8e9bcbe245a5ea07e5cdb4d24230.png" alt="" /></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    NSMutableArray *array = [NSMutableArray array];
    void(^Block)(void) = ^{
        [array addObject:@123]; // åªæ˜¯ä½¿ç”¨ï¼Œæœªèµ‹å€¼
    }
    Block();
}

{
    NSMutableArray *array = nil; // éœ€è¦æ·»åŠ __blockä¿®é¥°ç¬¦
    void(^Block)(void) = ^{
        array = [NSMutableArray array];
    }
    Block();
}
</code></pre></div></div>
<ul>
  <li>å¯¹å˜é‡è¿›è¡Œèµ‹å€¼æ—¶<br />
<img src="http://files.pandaleo.cn/a8a419108c4fb22d43283ba7b21c31bc.png?imageMogr2/thumbnail/!68p" alt="" />
<img src="http://files.pandaleo.cn/aa859656792c80c60e81ab73528f6d08.png?imageMogr2/thumbnail/!68p" alt="" /></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    __block int multiplier = 6;
    int(^Block)(int) = ^int(int num)
    {
        return num * multiplier;
    };
    multiplier = 4;
    NSLog(@"result is %d", Block(2)); // result is 8
}
</code></pre></div></div>
<ul>
  <li>__blockä¿®é¥°çš„å˜é‡å˜æˆäº†å¯¹è±¡
<img src="http://files.pandaleo.cn/235eb01e5dcf3f3d9c595cb09d77cfac.png" alt="" />
<img src="http://files.pandaleo.cn/64a4f870ea141a9b5ce83e8681a89696.png?imageMogr2/thumbnail/!68p" alt="" />
    <ul>
      <li>æ ˆä¸Šçš„__forwardingæŒ‡å‘è‡ªå·±ï¼Œå †ä¸Š__forwardingæŒ‡å‘åˆ«å¤„ã€‚</li>
    </ul>
  </li>
</ul>

<h4 id="4-blockçš„å†…å­˜ç®¡ç†">4. Blockçš„å†…å­˜ç®¡ç†</h4>
<p>impl.isa = &amp;_NSConcreteStackBlock
<img src="http://files.pandaleo.cn/f3fc6c338cf46c4d5d71cc5b0247736a.png?imageMogr2/thumbnail/!68p" alt="" /></p>
<ul>
  <li>Blockçš„Copyæ“ä½œ
<img src="http://files.pandaleo.cn/9352e27789c0805a3063722a830a88c3.png?imageMogr2/thumbnail/!68p" alt="" /></li>
  <li>æ ˆä¸ŠBlockçš„é”€æ¯
<img src="http://files.pandaleo.cn/eb56b951ba243874970618cb880e27b6.png?imageMogr2/thumbnail/!68p" alt="" /></li>
  <li>æ ˆä¸ŠBlockçš„Copyï¼Œå­˜åœ¨å†…å­˜æ³„æ¼
<img src="http://files.pandaleo.cn/b47fb2e771f9e79231325b68a1022041.png?imageMogr2/thumbnail/!68p" alt="" /></li>
  <li>æ ˆä¸Š__blockå˜é‡çš„copy
<img src="http://files.pandaleo.cn/622f45099e7ba741aa41db7d66a528ea.png?imageMogr2/thumbnail/!68p" alt="" />
ï¼ˆmultiplier.__forwading-&gt;multiplierï¼‰ = 4;
    <ul>
      <li>copyæ“ä½œæ—¶æ ˆä¸Šå’Œå †ä¸Šçš„ä¿®æ”¹æ“ä½œéƒ½æ˜¯ä¿®æ”¹å †ä¸Šçš„å˜é‡ï¼Œcopyæ“ä½œä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šï¼Œé‡æ–°è¿›è¡Œäº†å†…å­˜åˆ†é…</li>
      <li>écopyæ—¶ï¼Œä¿®æ”¹è‡ªèº«æ ˆä¸Šçš„å˜é‡</li>
    </ul>
  </li>
  <li>__forwadingæ€»ç»“
<img src="http://files.pandaleo.cn/c8625fea5d56fa68adb9a2efe440c062.png" alt="" />
    <ul>
      <li>_blkèµ‹å€¼æ“ä½œä¸ºcopyï¼Œä¿®æ”¹å †ä¸Šçš„æ•°æ®ï¼Œå‡½æ•°æ‰§è¡Œæ—¶ä¹Ÿæ˜¯ä½¿ç”¨å †å€¼</li>
      <li>ä¸è®ºåœ¨ä»»ä½•å†…å­˜ä½ç½®ï¼Œéƒ½å¯ä»¥é¡ºåˆ©è®¿é—®åŒä¸€ä¸ª__blockå˜é‡</li>
    </ul>
  </li>
</ul>

<h4 id="5-blockçš„å¾ªç¯å¼•ç”¨">5. Blockçš„å¾ªç¯å¼•ç”¨</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    _array = [NSMutableArray arrayWithObject:@"block"];
    _strBlk = ^NSString*(NSString *num){
        return [NSString stringwithFormat:@"helloc_%@", array[0]];
    }
    _strBlk(@"hello");
}
</code></pre></div></div>
<ul>
  <li>å­˜åœ¨è‡ªå¼•ç”¨å¾ªç¯å¼•ç”¨ï¼Œå¯¹è±¡ç±»å‹æˆªè·å˜é‡æ—¶ä¼šè¿åŒå±æ€§å…³é”®å­—strongã€‚
<img src="http://files.pandaleo.cn/b844fc426e4c0bc64fb4add1ea1f1341.png?imageMogr2/thumbnail/!68p" alt="" /></li>
  <li>è§£å†³æ–¹æ¡ˆï¼š__weak NSArray *weakArray = _array;<br />
<img src="http://files.pandaleo.cn/d6b1b340d22f383d5bdf20a3326dd16c.png?imageMogr2/thumbnail/!68p" alt="" />
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  __block TBlock* blockSelf = self;
  _blk = ^int(int num){
      // var = 2
      // blockSelf = nil; ARCè§£å†³æ–¹æ¡ˆ
      // å¦‚æœä¸€ç›´æœªä½¿ç”¨ï¼Œä¼šå¯¼è‡´ç¯ä¸€ç›´å­˜åœ¨ã€‚
      return num * blockSelf.var;
  }

  _blk(3);
}
</code></pre></div>    </div>
  </li>
  <li>åœ¨MRCä¸‹ï¼Œä¸ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨ã€‚å½“åœ¨MRCç¯å¢ƒæ—¶ï¼Œç›´æ¥å¤åˆ¶ï¼Œå¹¶ä¸ä¼šretainæ•è·çš„å¯¹è±¡ã€‚æ‰€ä»¥åœ¨MRCç¯å¢ƒä¸‹ï¼Œ__blockå¯ä»¥æ¶ˆé™¤å¾ªç¯å¼•ç”¨ã€‚</li>
  <li>åœ¨ARCä¸‹ï¼Œä¼šäº§ç”Ÿå¤§ç¯å¾ªç¯å¼•ç”¨ï¼Œå¼•èµ·å†…å­˜æ³„æ¼ã€‚
<img src="http://files.pandaleo.cn/528d69907fefa0a7920978ca00a32acd.png?imageMogr2/thumbnail/!68p" alt="" />
    <h4 id="6-æ€»ç»“">6. æ€»ç»“</h4>
  </li>
  <li>ä¸ºä»€ä¹ˆBlockä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨ï¼Ÿ
    <ul>
      <li>å½“å‰blockå¯¹æˆå‘˜å˜é‡æˆªè·æ—¶ï¼Œä¼šå¯¹å…¶å¼ºå¼•ç”¨ï¼Œå½“å‰å¯¹è±¡å¯¹blockä¹Ÿå­˜åœ¨å¼ºå¼•ç”¨æ—¶ï¼Œä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨ã€‚å¯ä»¥é€šè¿‡å£°æ˜__weakæ—¶ï¼Œæ¶ˆé™¤å¾ªç¯å¼•ç”¨ã€‚</li>
      <li>__blockæ—¶ï¼Œåœ¨ARCå­˜åœ¨å¾ªç¯å¼•ç”¨ï¼ŒMACä¸å­˜åœ¨ã€‚å¯ä»¥é€šè¿‡æ–­ç¯çš„æ–¹å¼è§£å†³å¾ªç¯å¼•ç”¨ï¼Œä½†æ˜¯å¦‚æœä¸€ç›´æœªè°ƒç”¨ä»ä¼šå­˜åœ¨ã€‚</li>
    </ul>
  </li>
  <li>æ€æ ·ç†è§£Blockæˆªè·å˜é‡çš„ç‰¹æ€§ï¼Ÿ
    <ul>
      <li>åŸºæœ¬ç±»å‹æˆªè·å…¶å€¼</li>
      <li>å¯¹è±¡ç±»å‹æˆªè·å¼ºå¼•ç”¨å’Œæ‰€æœ‰æƒä¿®é¥°ç¬¦</li>
      <li>é™æ€å±€éƒ¨å˜é‡ï¼Œæˆªè·å¼•ç”¨ç±»å‹</li>
      <li>ä¸æˆªè·å…¨å±€å’Œå…¨å±€é™æ€å˜é‡</li>
    </ul>
  </li>
  <li>blockå±æ€§ä¸ºä»€ä¹ˆè¦ä½¿ç”¨copy?
    <ul>
      <li>MRCä¸‹ï¼Œcopyå°†blockä»æ ˆæ‹·è´åˆ°åŒºï¼Œå› ä¸ºæ ˆä¸­å˜é‡å‡ºäº†ä½œç”¨åŸŸä¼šè¢«é”€æ¯ï¼Œæ— æ³•å…¨å±€ä½¿ç”¨ã€‚æ‰€ä»¥å°†å…¶æ‹·è´åˆ°å †åŒºå…¨å±€å…±äº«ï¼Œä¸ä¼šè¢«é”€æ¯ã€‚MRCæ‰‹åŠ¨ç®¡ç†å †åŒºï¼Œä¸éœ€è¦ç³»ç»Ÿç®¡ç†ã€‚</li>
      <li>ARCå¯ä»¥ä¸ä½¿ç”¨copyï¼Œå› ä¸ºå±æ€§å°±åœ¨å †åŒºã€‚</li>
    </ul>
  </li>
</ul>
:ET